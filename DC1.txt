
# Set details
$SERVERNAME = "dc1"
$FOREST = "maynooth.ads.electric-petrol.ie"
$DNSNAME = $SERVERNAME + "." + $FOREST

# Set the IP address for the DC (10.34.6.0 for Infrastructure servers as per network plan) No connectivity so no Default Gateway
Rename-Computer -NewName $SERVERNAME
Get-NetIPAddress
New-NetIPAddress -InterfaceIndex 16 -IPAddress 10.34.6.11 -PrefixLength 24 
Restart-Computer


#Install Active Directory for new Forest (prompted for Administrator Password during install)
Install-WindowsFeature -name AD-Domain-Services â€“IncludeManagementTools

Import-Module ADDSDeployment
Install-ADDSForest `
-CreateDnsDelegation:$false `
-DatabasePath "C:\Windows\NTDS" `
-DomainMode "WinThreshold" `
-DomainName "maynooth.ads.electric-petrol.ie" `
-DomainNetbiosName "maynooth" `
-ForestMode "WinThreshold" `
-InstallDns:$true `
-LogPath "C:\Windows\NTDS" `
-NoRebootOnCompletion:$false `
-SysvolPath "C:\Windows\SYSVOL" `
-Force:$true

Shutdown /r /t 0


# Install DHCP
Install-WindowsFeature DHCP -IncludeManagementTools

# Configure DHCP, add a single scope
$SERVERNAME = "dc1"
$FOREST = "maynooth.ads.electric-petrol.ie"
$DNSNAME = $SERVERNAME + "." + $FOREST
Add-DhcpServerInDC -DnsName $DNSNAME -IPAddress 10.34.6.11
Add-DhcpServerv4Scope -Name VLAN1 ISP -StartRange 10.34.1.100 -EndRange 10.34.1.199 -SubnetMask 255.255.255.0 -State Active -Description "DHCP addresses for Hosts that don't require a static address"
Add-DhcpServerv4Scope -Name VLAN2 Hosts -StartRange 10.34.2.100 -EndRange 10.34.2.199 -SubnetMask 255.255.255.0 -State Active -Description "DHCP addresses for Hosts that don't require a static address"
Add-DhcpServerv4Scope -Name VLAN3 StaffRadio -StartRange 10.34.3.100 -EndRange 10.34.3.199 -SubnetMask 255.255.255.0 -State Active -Description "DHCP addresses for Staff Wifi"
Add-DhcpServerv4Scope -Name VLAN4 Power -StartRange 10.34.4.100 -EndRange 10.34.4.199 -SubnetMask 255.255.255.0 -State Active -Description "DHCP addresses for power infrastructure that don't require a static address"
Add-DhcpServerv4Scope -Name VLAN5 TechnicalClients -StartRange 10.34.5.100 -EndRange 10.34.5.199 -SubnetMask 255.255.255.0 -State Active -Description "DHCP addresses for technical clients"
Add-DhcpServerv4Scope -Name VLAN6 InfraServers -StartRange 10.34.6.100 -EndRange 10.34.6.199 -SubnetMask 255.255.255.0 -State Active -State Active-Description "DHCP addresses for servers that don't require a static address"
Add-DhcpServerv4Scope -Name VLAN7 Telephony -StartRange 10.34.7.100 -EndRange 10.34.7.199 -SubnetMask 255.255.255.0 -State Active -Description "DHCP addresses for IP Phones"
Add-DhcpServerv4Scope -Name VLAN8 HVAC -StartRange 10.34.8.100 -EndRange 10.34.8.199 -SubnetMask 255.255.255.0 -State Active -Description "DHCP addresses for HVAC that don't require a static address"
Add-DhcpServerv4Scope -Name VLAN9 Storage -StartRange 10.34.9.100 -EndRange 10.34.9.199 -SubnetMask 255.255.255.0 -State Active -Description "DHCP addresses for Storage that don't require a static address"
Add-DhcpServerv4Scope -Name VLAN10 NetMan -StartRange 10.34.10.100 -EndRange 10.34.10.199 -SubnetMask 255.255.255.0 -State Active -Description "DHCP addresses for net management that don't require a static address"
Add-DhcpServerv4Scope -Name VLAN11 SecurityCameras -StartRange 10.34.11.100 -EndRange 10.34.11.199 -SubnetMask 255.255.255.0 -State Active -Description "DHCP addresses for Security Cameras"
Add-DhcpServerv4Scope -Name VLAN13 ClusterChat -StartRange 10.34.13.100 -EndRange 10.34.13.199 -SubnetMask 255.255.255.0  -State Active -Description "DHCP addresses for ClusterChat"
Add-DhcpServerv4Scope -Name VLAN14 LoopBacks -StartRange 10.34.14.100 -EndRange 10.34.14.199 -SubnetMask 255.255.255.0 -State Active -Description "DHCP addresses for Loopbacks"
Add-DhcpServerv4Scope -Name VLAN15 Routers -StartRange 10.34.15.100 -EndRange 10.34.15.199 -SubnetMask 255.255.255.0  -State Active -Description "DHCP addresses for Routers"
Add-DhcpServerv4Scope -Name VLAN16 Links -StartRange 10.34.16.100 -EndRange 10.34.16.199 -SubnetMask 255.255.255.0 -State Active -Description "DHCP addresses for Links"


# Create DHCP exclusions
Add-DhcpServerv4ExclusionRange -ScopeID 10.34.1.0 -StartRange 10.34.1.200 -EndRange 10.34.1.254
Add-DhcpServerv4ExclusionRange -ScopeID 10.34.2.0 -StartRange 10.34.2.200 -EndRange 10.34.2.254
Add-DhcpServerv4ExclusionRange -ScopeID 10.34.3.0 -StartRange 10.34.3.200 -EndRange 10.34.3.254
Add-DhcpServerv4ExclusionRange -ScopeID 10.34.4.0 -StartRange 10.34.4.200 -EndRange 10.34.4.254
Add-DhcpServerv4ExclusionRange -ScopeID 10.34.5.0 -StartRange 10.34.5.200 -EndRange 10.34.5.254
Add-DhcpServerv4ExclusionRange -ScopeID 10.34.6.0 -StartRange 10.34.6.200 -EndRange 10.34.6.254
Add-DhcpServerv4ExclusionRange -ScopeID 10.34.7.0 -StartRange 10.34.7.200 -EndRange 10.34.7.254
Add-DhcpServerv4ExclusionRange -ScopeID 10.34.8.0 -StartRange 10.34.8.200 -EndRange 10.34.8.254
Add-DhcpServerv4ExclusionRange -ScopeID 10.34.9.0 -StartRange 10.34.9.200 -EndRange 10.34.9.254
Add-DhcpServerv4ExclusionRange -ScopeID 10.34.10.0 -StartRange 10.34.10.200 -EndRange 10.34.10.254
Add-DhcpServerv4ExclusionRange -ScopeID 10.34.11.0 -StartRange 10.34.11.200 -EndRange 10.34.11.254
Add-DhcpServerv4ExclusionRange -ScopeID 10.34.13.0 -StartRange 10.34.13.200 -EndRange 10.34.13.254
Add-DhcpServerv4ExclusionRange -ScopeID 10.34.14.0 -StartRange 10.34.14.200 -EndRange 10.34.14.254
Add-DhcpServerv4ExclusionRange -ScopeID 10.34.15.0 -StartRange 10.34.15.200 -EndRange 10.34.15.254
Add-DhcpServerv4ExclusionRange -ScopeID 10.34.16.0 -StartRange 10.34.16.200 -EndRange 10.34.16.254


#Create DNS records for Servers storage and Hosts in Forward lookup zone
Add-DnsServerResourceRecordA -Name "host1" -ZoneName "maynooth.ads.electric-petrol.ie" -AllowUpdateAny -IPv4Address "10.34.2.11" -TimeToLive 01:00:00
Add-DnsServerResourceRecordA -Name "host2" -ZoneName "maynooth.ads.electric-petrol.ie" -AllowUpdateAny -IPv4Address "10.34.2.12" -TimeToLive 01:00:00
Add-DnsServerResourceRecordA -Name "db1" -ZoneName "maynooth.ads.electric-petrol.ie" -AllowUpdateAny -IPv4Address "10.34.6.31" -TimeToLive 01:00:00
Add-DnsServerResourceRecordA -Name "db2" -ZoneName "maynooth.ads.electric-petrol.ie" -AllowUpdateAny -IPv4Address "10.34.6.32" -TimeToLive 01:00:00
Add-DnsServerResourceRecordA -Name "app1" -ZoneName "maynooth.ads.electric-petrol.ie" -AllowUpdateAny -IPv4Address "10.34.6.33" -TimeToLive 01:00:00
Add-DnsServerResourceRecordA -Name "app2" -ZoneName "maynooth.ads.electric-petrol.ie" -AllowUpdateAny -IPv4Address "10.34.6.34" -TimeToLive 01:00:00
Add-DnsServerResourceRecordA -Name "backupsvr" -ZoneName "maynooth.ads.electric-petrol.ie" -AllowUpdateAny -IPv4Address "10.34.6.35" -TimeToLive 01:00:00
Add-DnsServerResourceRecordA -Name "filesvr1" -ZoneName "maynooth.ads.electric-petrol.ie" -AllowUpdateAny -IPv4Address "10.34.6.21" -TimeToLive 01:00:00
Add-DnsServerResourceRecordA -Name "filesvr2" -ZoneName "maynooth.ads.electric-petrol.ie" -AllowUpdateAny -IPv4Address "10.34.6.22" -TimeToLive 01:00:00
Add-DnsServerResourceRecordA -Name "nas1" -ZoneName "maynooth.ads.electric-petrol.ie" -AllowUpdateAny -IPv4Address "10.34.9.21" -TimeToLive 01:00:00


# Set time to sync'h with a local NTP server.
w32tm /config /manualpeerlist:10.34.15.254 /syncfromflags:manual /update

#Create OUs to Manage everything in Maynooth Branch
New-ADOrganizationalUnit -Name "Maynooth" -Path "DC=maynooth,DC=ads,DC=electric-petrol,DC=ie"
New-ADOrganizationalUnit -Name "People" -Path "OU=Maynooth,DC=maynooth,DC=ads,DC=electric-petrol,DC=ie" 
New-ADOrganizationalUnit -Name "Accounts" -Path "OU=People,OU=Maynooth,DC=maynooth,DC=ads,DC=electric-petrol,DC=ie" 
New-ADOrganizationalUnit -Name "Domain Admins" -Path "OU=People,OU=Maynooth,DC=maynooth,DC=ads,DC=electric-petrol,DC=ie" 
New-ADOrganizationalUnit -Name "Human Resources" -Path "OU=People,OU=Maynooth,DC=maynooth,DC=ads,DC=electric-petrol,DC=ie" 
New-ADOrganizationalUnit -Name "Manuafacturing" -Path "OU=People,OU=Maynooth,DC=maynooth,DC=ads,DC=electric-petrol,DC=ie" 
New-ADOrganizationalUnit -Name "Computers" -Path "OU=Maynooth,DC=maynooth,DC=ads,DC=electric-petrol,DC=ie"
New-ADOrganizationalUnit -Name "Clients" -Path "OU=Computers,OU=Maynooth,DC=maynooth,DC=ads,DC=electric-petrol,DC=ie"
New-ADOrganizationalUnit -Name "Win10" -Path "OU=Clients,OU=Computers,OU=Maynooth,DC=maynooth,DC=ads,DC=electric-petrol,DC=ie"
New-ADOrganizationalUnit -Name "Win11" -Path "OU=Clients,OU=Computers,OU=Maynooth,DC=maynooth,DC=ads,DC=electric-petrol,DC=ie"
New-ADOrganizationalUnit -Name "Servers" -Path "OU=Computers,OU=Maynooth,DC=maynooth,DC=ads,DC=electric-petrol,DC=ie"
New-ADOrganizationalUnit -Name "File Servers" -Path "OU=Servers,OU=Computers,OU=Maynooth,DC=maynooth,DC=ads,DC=electric-petrol,DC=ie"
New-ADOrganizationalUnit -Name "Application Servers" -Path "OU=Servers,OU=Computers,OU=Maynooth,DC=maynooth,DC=ads,DC=electric-petrol,DC=ie"
New-ADOrganizationalUnit -Name "Database Servers" -Path "OU=Servers,OU=Computers,OU=Maynooth,DC=maynooth,DC=ads,DC=electric-petrol,DC=ie"
New-ADOrganizationalUnit -Name "Domain Controllers" -Path "OU=Servers,OU=Computers,OU=Maynooth,DC=maynooth,DC=ads,DC=electric-petrol,DC=ie"



#Create Reverse lookup zones with Fortest wide replication
Add-DnsServerPrimaryZone -NetworkID 10.34.1.0/24 -ReplicationScope "Forest"
Add-DnsServerPrimaryZone -NetworkID 10.34.2.0/24 -ReplicationScope "Forest"
Add-DnsServerPrimaryZone -NetworkID 10.34.3.0/24 -ReplicationScope "Forest"
Add-DnsServerPrimaryZone -NetworkID 10.34.4.0/24 -ReplicationScope "Forest"
Add-DnsServerPrimaryZone -NetworkID 10.34.5.0/24 -ReplicationScope "Forest"
Add-DnsServerPrimaryZone -NetworkID 10.34.6.0/24 -ReplicationScope "Forest"
Add-DnsServerPrimaryZone -NetworkID 10.34.7.0/24 -ReplicationScope "Forest"
Add-DnsServerPrimaryZone -NetworkID 10.34.8.0/24 -ReplicationScope "Forest"
Add-DnsServerPrimaryZone -NetworkID 10.34.9.0/24 -ReplicationScope "Forest"
Add-DnsServerPrimaryZone -NetworkID 10.34.10.0/24 -ReplicationScope "Forest"
Add-DnsServerPrimaryZone -NetworkID 10.34.11.0/24 -ReplicationScope "Forest"
Add-DnsServerPrimaryZone -NetworkID 10.34.13.0/24 -ReplicationScope "Forest"
Add-DnsServerPrimaryZone -NetworkID 10.34.14.0/24 -ReplicationScope "Forest"
Add-DnsServerPrimaryZone -NetworkID 10.34.15.0/24 -ReplicationScope "Forest"
Add-DnsServerPrimaryZone -NetworkID 10.34.16.0/24 -ReplicationScope "Forest"

#Create Reverse lookup PTR records for each server 
Add-DnsServerResourceRecordPtr -Name "11" -ZoneName "2.34.10.in-addr.arpa" -AllowUpdateAny -TimeToLive 01:00:00 -AgeRecord -PtrDomainName "host1.maynooth.ads.electric-petrol.ie"
Add-DnsServerResourceRecordPtr -Name "12" -ZoneName "2.34.10.in-addr.arpa" -AllowUpdateAny -TimeToLive 01:00:00 -AgeRecord -PtrDomainName "host2.maynooth.ads.electric-petrol.ie"
Add-DnsServerResourceRecordPtr -Name "31" -ZoneName "6.34.10.in-addr.arpa" -AllowUpdateAny -TimeToLive 01:00:00 -AgeRecord -PtrDomainName "db1.maynooth.ads.electric-petrol.ie"
Add-DnsServerResourceRecordPtr -Name "32" -ZoneName "6.34.10.in-addr.arpa" -AllowUpdateAny -TimeToLive 01:00:00 -AgeRecord -PtrDomainName "db2.maynooth.ads.electric-petrol.ie"
Add-DnsServerResourceRecordPtr -Name "33" -ZoneName "6.34.10.in-addr.arpa" -AllowUpdateAny -TimeToLive 01:00:00 -AgeRecord -PtrDomainName "app1.maynooth.ads.electric-petrol.ie"
Add-DnsServerResourceRecordPtr -Name "34" -ZoneName "6.34.10.in-addr.arpa" -AllowUpdateAny -TimeToLive 01:00:00 -AgeRecord -PtrDomainName "app2.maynooth.ads.electric-petrol.ie"
Add-DnsServerResourceRecordPtr -Name "35" -ZoneName "6.34.10.in-addr.arpa" -AllowUpdateAny -TimeToLive 01:00:00 -AgeRecord -PtrDomainName "backupsvr.maynooth.ads.electric-petrol.ie"
Add-DnsServerResourceRecordPtr -Name "21" -ZoneName "6.34.10.in-addr.arpa" -AllowUpdateAny -TimeToLive 01:00:00 -AgeRecord -PtrDomainName "filesvr1.maynooth.ads.electric-petrol.ie"
Add-DnsServerResourceRecordPtr -Name "22" -ZoneName "6.34.10.in-addr.arpa" -AllowUpdateAny -TimeToLive 01:00:00 -AgeRecord -PtrDomainName "filesvr2.maynooth.ads.electric-petrol.ie"
Add-DnsServerResourceRecordPtr -Name "21" -ZoneName "9.34.10.in-addr.arpa" -AllowUpdateAny -TimeToLive 01:00:00 -AgeRecord -PtrDomainName "nas1.maynooth.ads.electric-petrol.ie"


#Move all Domain Controllers to Domain Controller OU under Maynooth OU - run after completing build of dc2
Get-ADComputer -filter * -SearchBase "OU=Domain Controllers,DC=maynooth,DC=ads,DC=electric-petrol,DC=ie" | Move-ADObject -TargetPath "OU=Domain Controllers,OU=Servers,OU=Computers,OU=Maynooth,DC=maynooth,DC=ads,DC=electric-petrol,DC=ie"


#Make dc2 a dhcp failover for all scopes in an active active active relationship with shared secret and load balance 70% dc1 30% dc2 max client lead time 2 hours

Add-DhcpServerv4Failover -ComputerName "dc1.maynooth.ads.electric-petrol.ie" -Name "SFO-SIN-Failover" -PartnerServer "dc2.maynooth.ads.electric-petrol.ie" -ScopeId 10.34.1.0,10.34.2.0,10.34.3.0,10.34.4.0,10.34.5.0,10.34.6.0,10.34.7.0,10.34.8.0,10.34.9.0,10.34.10.0,10.34.11.0,10.34.13.0,10.34.14.0,10.34.15.0,10.34.16.0 -SharedSecret "Passw0rd" -LoadBalancePercent 70 -MaxClientLeadTime 2:00:00 -AutoStateTransition $True -StateSwitchInterval 2:00:00
